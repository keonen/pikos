import urequests
import uasyncio

# --- YLE DEVELOPER API SETTINGS ---
YLE_APP_ID = "9983745ba75676ef..."
YLE_APP_KEY = "5e997751a3765b..." # Huom: Tarkista avaimen pituus

class NewsApp:
    def __init__(self):
        self.news_lines = ["Ladataan Yle uutisia..."]
        self.url = f"https://external.api.yle.fi/v1/teletext/pages/102.json?app_id={YLE_APP_ID}&app_key={YLE_APP_KEY}"
        
        self.tiny_font = {
            'A':[0x2,0x5,0x7,0x5,0x5],'B':[0x6,0x5,0x6,0x5,0x6],'C':[0x3,0x4,0x4,0x4,0x3],
            'D':[0x6,0x5,0x5,0x5,0x6],'E':[0x7,0x4,0x6,0x4,0x7],'F':[0x7,0x4,0x6,0x4,0x4],
            'G':[0x3,0x4,0x5,0x5,0x3],'H':[0x5,0x5,0x7,0x5,0x5],'I':[0x7,0x2,0x2,0x2,0x7],
            'J':[0x1,0x1,0x1,0x5,0x2],'K':[0x5,0x5,0x6,0x5,0x5],'L':[0x4,0x4,0x4,0x4,0x7],
            'M':[0x5,0x7,0x5,0x5,0x5],'N':[0x5,0x6,0x5,0x5,0x5],'O':[0x2,0x5,0x5,0x5,0x2],
            'P':[0x6,0x5,0x6,0x4,0x4],'Q':[0x3,0x5,0x3,0x1,0x1],'R':[0x6,0x5,0x6,0x5,0x5],
            'S':[0x3,0x4,0x2,0x1,0x6],'T':[0x7,0x2,0x2,0x2,0x2],'U':[0x5,0x5,0x5,0x5,0x2],
            'V':[0x5,0x5,0x5,0x2,0x2],'W':[0x5,0x5,0x5,0x7,0x5],'X':[0x5,0x5,0x2,0x5,0x5],
            'Y':[0x5,0x5,0x2,0x2,0x2],'Z':[0x7,0x1,0x2,0x4,0x7],
            'a':[0x0,0x3,0x5,0x5,0x3],'b':[0x4,0x4,0x6,0x5,0x6],'c':[0x0,0x3,0x4,0x4,0x3],
            'd':[0x1,0x1,0x3,0x5,0x3],'e':[0x0,0x3,0x7,0x4,0x3],'f':[0x2,0x5,0x4,0x4,0x4],
            'g':[0x3,0x5,0x3,0x1,0x6],'h':[0x4,0x4,0x6,0x5,0x5],'i':[0x2,0x0,0x2,0x2,0x2],
            'j':[0x1,0x0,0x1,0x1,0x2],'k':[0x4,0x5,0x6,0x5,0x5],'l':[0x2,0x2,0x2,0x2,0x2],
            'm':[0x0,0x5,0x7,0x5,0x5],'n':[0x0,0x6,0x5,0x5,0x5],'o':[0x0,0x2,0x5,0x5,0x2],
            'p':[0x6,0x5,0x6,0x4,0x4],'q':[0x3,0x5,0x3,0x1,0x1],'r':[0x0,0x5,0x6,0x4,0x4],
            's':[0x0,0x3,0x2,0x1,0x6],'t':[0x2,0x7,0x2,0x2,0x2],'u':[0x0,0x5,0x5,0x5,0x3],
            'v':[0x0,0x5,0x5,0x5,0x2],'w':[0x0,0x5,0x5,0x7,0x5],'x':[0x0,0x5,0x2,0x5,0x5],
            'y':[0x0,0x5,0x5,0x3,0x1],'z':[0x0,0x7,0x1,0x2,0x7],
            '0':[0x2,0x5,0x5,0x5,0x2],'1':[0x2,0x6,0x2,0x2,0x7],'.':[0x0,0x0,0x0,0x0,0x2],
            ':':[0x0,0x2,0x0,0x2,0x0],'-':[0x0,0x0,0x7,0x0,0x0],' ':[0x0,0x0,0x0,0x0,0x0]
        }

    def draw_tiny(self, fb, text, x, y):
        curr_x, curr_y = x, y
        for char in str(text):
            if char in self.tiny_font:
                bitmap = self.tiny_font[char]
                for row in range(5):
                    for col in range(3):
                        if (bitmap[row] >> (2 - col)) & 1:
                            fb.pixel(curr_x + col, curr_y + row, 1)
            curr_x += 4
            if curr_x >= 80:
                curr_x = x
                curr_y += 7
            if curr_y > 42: break

    async def update_data(self):
        while True:
            try:
                res = urequests.get(self.url)
                data = res.json()
                res.close()
                
                # Navigoidaan JSON-rakenteessa subpage -> content -> line
                subpage = data["teletext"]["page"]["subpage"][0]
                lines_data = subpage["content"][0]["line"]
                
                new_headlines = []
                for item in lines_data:
                    num = int(item.get("number", 0))
                    # Otetaan vain rivit 4-10
                    if 4 <= num <= 10:
                        text = item.get("Text", "").strip()
                        if text:
                            # Skandien ja ylimääräisten merkkien siivous
                            text = text.replace('ä','a').replace('Ä','A').replace('ö','o').replace('Ö','O')
                            # Poistetaan sivunumeroviittaukset alusta (esim "103 ")
                            if text[0:3].isdigit(): text = text[3:].strip()
                            new_headlines.append(text)
                
                self.news_lines = new_headlines if new_headlines else ["Ei uutisia"]
                
            except Exception as e:
                print("Yle API error:", e)
                self.news_lines = ["Yle virhe"]
            
            await uasyncio.sleep(3600) # Päivitys kerran tunnissa

    def draw(self, fb):
        fb.text("UUTISET", 0, 0, 1)
        fb.hline(0, 9, 84, 1)
        
        y_cursor = 12
        for i in range(min(3, len(self.news_lines))):
            txt = "- " + self.news_lines[i]
            self.draw_tiny(fb, txt, 0, y_cursor)
            # Lasketaan rivit (n. 20 merkkiä/rivi)
            rows = (len(txt) // 21) + 1
            y_cursor += (rows * 7) + 2

